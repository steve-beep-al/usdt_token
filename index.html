<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Claim 5 Coins</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #status { margin-top: 12px; color: #333; }
    #log { margin-top: 12px; white-space: pre-wrap; background:#f7f7f7; padding:8px; border:1px solid #ddd; height:120px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Claim 5 Coins</h1>
  <button id="claimBtn">Claim Now</button>

  <div id="status">Ready</div>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    /*************** CONFIG - REPLACE THESE ***************/
    const tokenAddress    = "0x0D8C190055e5BdC488D00086CFdfE45A7704C28C"; // <-- REPLACE with your deployed token contract (on testnet)
    const tokenSymbol     = "USDT";
    const tokenDecimals   = 6;
    const tokenImage      = "https://png.pngtree.com/png-vector/20220513/ourmid/pngtree-tetherusdtvector-illustration-of-a-wellknown-altcoin-cryptocurrency-icon-vector-png-image_36462248.png"; // <-- HTTPS PNG
    const infuraRpc       = "https://mainnet.infura.io/v3/1e9849934a564257b9a2c77ece0b15c5"; // <-- REPLACE with your Infura endpoint
    const chainIdHex      = '1'; // Goerli = 0x5 (change to correct chain if needed)
    const chainName       = 'Ethereum';
    const mintAmount      = ethers.utils.parseUnits("5", tokenDecimals); // 5 tokens
    /*****************************************************/

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    function log(...args) {
      console.log(...args);
      logEl.innerText += args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ') + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(s) { statusEl.innerText = s; log('STATUS:', s); }

    const rpcParams = {
      chainId: chainIdHex,
      chainName: chainName,
      rpcUrls: [infuraRpc],
      nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
      blockExplorerUrls: ['https://etherscan.io']
    };

    // minimal ABIs we need
    const tokenAbi = [
      "function mint(address to, uint256 amount) public",
      "function balanceOf(address owner) view returns (uint256)",
      "function owner() view returns (address)",    // optional - many tokens have this
      "event Transfer(address indexed from, address indexed to, uint256 value)"
    ];

    // main flow
    async function claimDemoCoins() {
      try {
        setStatus('Checking for MetaMask / wallet...');
        if (typeof window.ethereum === 'undefined') {
          setStatus('MetaMask not detected. Install MetaMask and reload.');
          return;
        }

        // request connection & accounts
        setStatus('Requesting account access...');
        await window.ethereum.request({ method: 'eth_requestAccounts' }); // prompt connect
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        log('Connected address:', userAddress);
        setStatus('Connected: ' + userAddress);

        // check chain
        const currentChain = await provider.send('eth_chainId', []);
        log('Current chainId:', currentChain);
        if (currentChain !== chainIdHex) {
          setStatus('Switching/adding network in wallet...');
          try {
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [1e9849934a564257b9a2c77ece0b15c5] });
            setStatus('Network added/switch requested — please confirm in wallet.');
            // wait a moment for the user to accept and chain to change
            await new Promise(r => setTimeout(r, 1200));
          } catch (err) {
            log('Network add/switch rejected or failed:', err);
            throw new Error('Network add/switch was rejected or failed.');
          }
        }

        // confirm chain again
        const afterChain = await provider.send('eth_chainId', []);
        if (afterChain !== chainIdHex) {
          throw new Error('Please switch your wallet to the configured network and try again.');
        }

        // add token UI to MetaMask
        setStatus('Requesting wallet to watch token (add token)...');
        try {
          const wasAdded = await window.ethereum.request({
            method: 'wallet_watchAsset',
            params: {
              type: 'ERC20',
              options: {
                address: tokenAddress,
                symbol: tokenSymbol,
                decimals: tokenDecimals,
                image: tokenImage
              }
            }
          });
          log('wallet_watchAsset result:', wasAdded);
          if (!wasAdded) {
            log('User declined to add token UI; continuing (token added manually might be required).');
          } else {
            setStatus('Token added in wallet UI (or user confirmed).');
          }
        } catch(e) {
          log('wallet_watchAsset failed:', e);
        }

        // prepare contract instance
        setStatus('Preparing contract instance...');
        const tokenContractWithSigner = new ethers.Contract(tokenAddress, tokenAbi, signer);
        const tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);

        // optional: check owner if function exists
        let ownerAddress = null;
        try {
          ownerAddress = await tokenContract.owner();
          log('Owner() detected:', ownerAddress);
          if (ownerAddress.toLowerCase() !== userAddress.toLowerCase()) {
            log('Connected account is NOT the owner. mint() will likely revert unless contract allows public minting.');
            setStatus('Warning: your connected account is not owner. mint() may fail.');
          } else {
            log('Connected account is owner — good to mint.');
          }
        } catch (e) {
          log('owner() not found or failed (contract may not expose owner). continuing...');
        }

        // call mint
        setStatus('Sending mint transaction — confirm in MetaMask...');
        try {
          const tx = await tokenContractWithSigner.mint(userAddress, mintAmount);
          log('Mint tx sent:', tx.hash);
          setStatus('Mint tx sent. Waiting for confirmation...');
          await tx.wait();
          log('Mint tx confirmed.');
          setStatus('Mint confirmed — tokens should appear in wallet balance.');
        } catch (e) {
          log('Mint failed or reverted:', e);
          throw new Error('mint() failed. Check contract permissions (owner-only) and that you are using the owner account.');
        }

        // update and watch balance
        await updateBalance(provider, userAddress);

        // start listening for transfers (using provider)
        listenTransfers(provider, userAddress);

      } catch (err) {
        console.error(err);
        setStatus('Error: ' + (err.message || err));
        log('Error details:', err);
      }
    }

    async function updateBalance(provider, userAddress) {
      try {
        const tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);
        const raw = await tokenContract.balanceOf(userAddress);
        const human = Number(ethers.utils.formatUnits(raw, tokenDecimals));
        setStatus(`Balance: ${human} ${tokenSymbol}`);
        log('Balance update:', human);
      } catch (e) {
        log('Failed to read balance:', e);
      }
    }

    function listenTransfers(provider, userAddress) {
      try {
        const tokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);
        tokenContract.on('Transfer', async (from, to, value) => {
          log('Transfer event:', { from, to, value: value.toString() });
          // update balance if related to user
          if (!userAddress) return;
          if (from.toLowerCase() === userAddress.toLowerCase() || to.toLowerCase() === userAddress.toLowerCase()) {
            await updateBalance(provider, userAddress);
          }
        });
        log('Listening for Transfer events on token.');
      } catch (e) {
        log('Failed to listen to Transfer events:', e);
      }
    }

    // attach button handler
    document.getElementById('claimBtn').onclick = claimDemoCoins;

    // helper: show console tip
    log('Demo page loaded. Open DevTools Console for detailed logs.');
    setStatus('Ready — click Claim Now');

  </script>
</body>
</html>
