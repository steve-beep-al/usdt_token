<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Claim 5 Coins</title>
</head>
<body>
  <h1>Claim 5 Coins!</h1>
  <button id="connectBtn">Connect Wallet</button>
  <button id="claimBtn" disabled>Claim Now</button>

  <h2>Your Balance: <span id="balance">0</span> DEMO</h2>
  <h2>Value: $<span id="value">0</span></h2>

  <!-- Load MetaMask SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@metamask/sdk@0.17.1/dist/browser/iife/index.min.js"></script>
  <!-- Load ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <script type="module">
    // === CONFIG ===
    const tokenAddress = "0x0D8C190055e5BdC488D00086CFdfE45A7704C28C";  // Replace with deployed contract
    const tokenSymbol = "USDT";
    const tokenDecimals = 6;
    const tokenImage = https://png.pngtree.com/png-vector/20220513/ourmid/pngtree-tetherusdtvector-illustration-of-a-wellknown-altcoin-cryptocurrency-icon-vector-png-image_36462248.png";
    const mintAmount = ethers.utils.parseUnits("5", tokenDecimals);
    const tokenPrice = 1; // $1 per token (demo)

    const tokenAbi = [
      "function mint(address to, uint256 amount) public",
      "function balanceOf(address owner) view returns (uint256)",
      "event Transfer(address indexed from, address indexed to, uint256 value)"
    ];

    let ethereum, provider, signer, userAddress, tokenContract;

    // === INIT METAMASK SDK ===
    const MMSDK = new window.MetaMaskSDK.MetaMaskSDK({
      dappMetadata: {
        name: " Token Dapp",
        url: window.location.href,
      },
      infuraAPIKey: "1e9849934a564257b9a2c77ece0b15c5", // Replace with your Infura key
    });

    ethereum = MMSDK.getProvider();

    // === CONNECT WALLET ===
    async function connectWallet() {
      try {
        const accounts = await MMSDK.connect();
        userAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(ethereum);
        signer = provider.getSigner();
        tokenContract = new ethers.Contract(tokenAddress, tokenAbi, signer);

        document.getElementById("connectBtn").innerText = "Connected: " + userAddress.slice(0,6) + "...";
        document.getElementById("claimBtn").disabled = false;

        await updateBalance();

        // Listen for live transfers
        tokenContract.on("Transfer", async (from, to, value) => {
          if (from === userAddress || to === userAddress) {
            await updateBalance();
          }
        });
      } catch (err) {
        console.error("Connect error:", err);
        alert("Failed to connect: " + err.message);
      }
    }

    // === CLAIM TOKENS ===
    async function claimDemoCoins() {
      try {
        const tx = await tokenContract.mint(userAddress, mintAmount);
        await tx.wait();

        alert("âœ… 5 Demo Coins minted!");
        await updateBalance();
      } catch (err) {
        console.error("Mint error:", err);
        alert("Mint failed: " + err.message);
      }
    }

    // === UPDATE BALANCE & VALUE ===
    async function updateBalance() {
      const rawBalance = await tokenContract.balanceOf(userAddress);
      const balance = Number(ethers.utils.formatUnits(rawBalance, tokenDecimals));
      document.getElementById("balance").innerText = balance;
      document.getElementById("value").innerText = (balance * tokenPrice).toFixed(2);
    }

    // === BUTTONS ===
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("claimBtn").onclick = claimDemoCoins;
  </script>
</body>
</html>
